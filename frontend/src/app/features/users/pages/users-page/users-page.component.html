<!-- English: User management page with filters, table, and modals. -->
<!-- Italiano: pagina gestione utenti con filtri, tabella e modali. -->
<!-- English: Sections include header, filters, table, states, and modals. -->
<!-- Italiano: Sezioni: header, filtri, tabella, stati e modali. -->
<!-- English: UI/UX choice: separate cards to isolate filters and results. -->
<!-- Italiano: Scelte UI/UX: card separate per isolare filtri e risultati. -->
<section class="users-page">
  <!-- English: Page header with quick actions. -->
  <!-- Italiano: Header pagina con azioni rapide. -->
  <page-header title="User management" subtitle="Manage access, roles, and user status.">
    <div actions>
      <ui-button variant="secondary" (click)="loadUsers()">Refresh</ui-button>
    </div>
  </page-header>

  <!-- English: Search filters card. -->
  <!-- Italiano: Card filtri di ricerca. -->
  <app-card>
    <user-filters
      [filters]="filters"
      [roleOptions]="roleOptions"
      [companyOptions]="companyOptions"
      (filtersChange)="onFiltersChange($event)"
    ></user-filters>
  </app-card>

  <!-- English: Users table card with status. -->
  <!-- Italiano: Card tabella utenti con stati. -->
  <app-card class="table-card">
    <div class="table-header">
      <div>
        <h3>Users</h3>
        <p class="helper">{{ filteredUsers.length }} results</p>
      </div>
    </div>

    <!-- English: Error state. -->
    <!-- Italiano: Stato errore. -->
    <empty-state
      *ngIf="error"
      title="Failed to load"
      [description]="error"
    >
      <ui-button variant="secondary" (click)="loadUsers()">Retry</ui-button>
    </empty-state>

    <!-- English: Users table with actions. -->
    <!-- Italiano: Tabella utenti con azioni. -->
    <user-table
      *ngIf="!error && (loading || filteredUsers.length)"
      [users]="filteredUsers"
      [loading]="loading"
      (toggleStatus)="onToggleRequest($event)"
      (viewUser)="openDetail($event, 'view')"
      (editUser)="openDetail($event, 'edit')"
    ></user-table>

    <!-- English: Empty state for filters. -->
    <!-- Italiano: Stato vuoto per filtri. -->
    <empty-state
      *ngIf="!loading && !error && !filteredUsers.length"
      title="No users found"
      description="Try adjusting the filters or search."
    >
      <ui-button variant="ghost" (click)="resetFilters()">
        Reset filters
      </ui-button>
    </empty-state>
  </app-card>

  <!-- English: Confirmation modal for enable/disable. -->
  <!-- Italiano: Modale di conferma per abilita/disabilita. -->
  <ui-modal
    [open]="confirmOpen"
    [title]="pendingToggle?.nextEnabled ? 'Enable user' : 'Disable user'"
    [description]="pendingToggle?.nextEnabled ? 'The user will regain access to the CRM.' : 'The user will no longer be able to access the CRM.'"
    [confirmLabel]="pendingToggle?.nextEnabled ? 'Enable' : 'Disable'"
    [confirmVariant]="pendingToggle?.nextEnabled ? 'primary' : 'danger'"
    (confirm)="confirmToggle()"
    (cancel)="cancelToggle()"
  >
    <p class="modal-text" *ngIf="pendingToggle?.user">
      Confirm the action for <strong>{{ pendingToggle?.user?.email }}</strong>?
    </p>
  </ui-modal>

  <!-- English: User detail modal (view/edit). -->
  <!-- Italiano: Modale dettaglio utente (view/edit). -->
  <ui-modal
    [open]="detailOpen"
    [title]="detailMode === 'edit' ? 'Edit user' : 'User details'"
    [description]="detailMode === 'edit' ? 'Editing will be available in a future version.' : 'Key information and access.'"
    confirmLabel="Close"
    confirmVariant="secondary"
    [showCancel]="false"
    (confirm)="closeDetail()"
    (cancel)="closeDetail()"
  >
    <user-form [user]="selectedUser" [mode]="detailMode" [readOnly]="true"></user-form>
  </ui-modal>
</section>
